services:
  # ==========================================================================
  # IB Gateway Container
  # ==========================================================================
  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:latest
    container_name: ib-gateway
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    environment:
      - TZ=Europe/Prague
      - TWS_USERID=${IBKR_USERNAME}
      - TWS_PASSWORD=${IBKR_PASSWORD}
      - TRADING_MODE=${TRADING_MODE:-paper}
      - VNC_SERVER_PASSWORD=${VNC_PASSWORD:-password}
      - READ_ONLY_API=no
      - TWS_SETTINGS_PATH=/home/ibgateway/tws_settings
    # Persist settings to a specific path to avoid overwriting app files
    volumes:
      - ./tws_settings:/home/ibgateway/tws_settings

  # ==========================================================================
  # Vanna Trader Container
  # ==========================================================================
  trader:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vanna-trader
    restart: unless-stopped
    network_mode: host
    shm_size: 2gb # PPO/PyTorch Requirement
    mem_limit: 4g # Attempt to give max RAM
    ulimits:
      memlock: -1
      stack: 67108864
    depends_on:
      - ib-gateway
    environment:
      - TZ=Europe/Prague
      - IBKR_HOST=127.0.0.1
      - IBKR_PORT=4002
      - IBKR_CLIENT_ID=${IBKR_CLIENT_ID:-999}
      - IBKR_ACCOUNT=${IBKR_ACCOUNT}
      # Stability (Fix for PyTorch Segfaults on RPi)
      - OMP_NUM_THREADS=1
      - MKL_NUM_THREADS=1
      - OPENBLAS_NUM_THREADS=1
      - VECLIB_MAXIMUM_THREADS=1
      - NUMEXPR_NUM_THREADS=1
      # AI
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Trading
      - MAX_RISK_PER_TRADE=${MAX_RISK_PER_TRADE:-120}
      - MAX_ALLOCATION_PERCENT=${MAX_ALLOCATION_PERCENT:-25}
      - PAPER_TRADING=${PAPER_TRADING:-true}
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    healthcheck:
      test: [ "CMD-SHELL", "pgrep -f 'python main.py' || exit 1" ]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 120s # Allow 2 mins for startup (PPO load)
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
      - .:/app
